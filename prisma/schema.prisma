// Schema Prisma - Sistema Gestionale Weiss Cafè
// Modulo 1: Contabilità e Controllo di Gestione

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== UTENTI E AUTENTICAZIONE ====================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @relation(fields: [roleId], references: [id])
  roleId       String   @map("role_id")
  venue        Venue?   @relation(fields: [venueId], references: [id])
  venueId      String?  @map("venue_id")
  hourlyRate   Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  isFixedStaff Boolean  @default(false) @map("is_fixed_staff")
  defaultShift Shift?   @map("default_shift") // Turno di default per presenze
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // === FASE 4: Dati contrattuali estesi ===
  contractType      ContractType? @map("contract_type")
  contractHoursWeek Decimal?      @map("contract_hours_week") @db.Decimal(4, 1)
  hireDate          DateTime?     @map("hire_date") @db.Date
  terminationDate   DateTime?     @map("termination_date") @db.Date

  // Tariffe orarie estese
  hourlyRateBase    Decimal? @map("hourly_rate_base") @db.Decimal(10, 2)
  hourlyRateExtra   Decimal? @map("hourly_rate_extra") @db.Decimal(10, 2)
  hourlyRateHoliday Decimal? @map("hourly_rate_holiday") @db.Decimal(10, 2)
  hourlyRateNight   Decimal? @map("hourly_rate_night") @db.Decimal(10, 2)

  // Accesso portale dipendente
  portalEnabled Boolean @default(false) @map("portal_enabled")
  portalPin     String? @map("portal_pin")
  appToken      String? @map("app_token")

  // Preferenze notifiche
  notifyEmail    Boolean @default(true) @map("notify_email")
  notifyPush     Boolean @default(true) @map("notify_push")
  notifyWhatsapp Boolean @default(false) @map("notify_whatsapp")
  whatsappNumber String? @map("whatsapp_number")

  // Skills e competenze
  skills        String[] @default([])
  canWorkAlone  Boolean  @default(false) @map("can_work_alone")
  canHandleCash Boolean  @default(true) @map("can_handle_cash")

  // Relazioni esistenti
  submittedClosures DailyClosure[]    @relation("SubmittedBy")
  validatedClosures DailyClosure[]    @relation("ValidatedBy")
  journalEntries    JournalEntry[]
  attendanceRecords DailyAttendance[]
  budgetsCreated    Budget[]

  // Relazioni Fase 4
  constraints             EmployeeConstraint[]
  relationshipConstraints RelationshipConstraintUser[]
  shiftAssignments        ShiftAssignment[]
  leaveRequests           LeaveRequest[]
  leaveBalances           LeaveBalance[]
  approvedLeaveRequests   LeaveRequest[]               @relation("ApprovedBy")

  // Relazioni Fase 4.4 - Timbratura
  attendancePunches   AttendanceRecord[]
  attendanceAnomalies AttendanceAnomaly[]

  // Relazioni Fase 5.2 - Notifiche
  notificationPreferences NotificationPreference?

  @@map("users")
}

// === FASE 4: TIPO CONTRATTO ===
enum ContractType {
  FISSO
  EXTRA
  INTERMITTENTE
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // "admin", "manager", "staff"
  description String?
  isCustom    Boolean  @default(false) @map("is_custom")
  createdAt   DateTime @default(now()) @map("created_at")

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(cuid())
  code        String  @unique // "closure.create", "closure.validate", etc.
  description String?
  module      String // "cash", "bank", "reports", "admin"

  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String     @map("role_id")
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String     @map("permission_id")

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ==================== SEDI ====================

model Venue {
  id           String   @id @default(cuid())
  name         String // "Weiss Cafè", "Villa Varda", "Casette"
  code         String   @unique // "WEISS", "VV", "CAS"
  address      String?
  defaultFloat Decimal  @default(114.00) @map("default_float") @db.Decimal(10, 2)
  vatRate      Decimal  @default(10.00) @map("vat_rate") @db.Decimal(5, 2)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Coordinate per geolocalizzazione (Fase 4.4)
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  users            User[]
  closures         DailyClosure[]
  journalEntries   JournalEntry[]
  stationTemplates CashStationTemplate[]
  registerBalances RegisterBalance[]
  initialBalances  InitialBalance[]
  budgets          Budget[]
  budgetCategories BudgetCategory[]

  // Relazioni Fase 4
  employeeConstraints     EmployeeConstraint[]
  relationshipConstraints RelationshipConstraint[]
  shiftDefinitions        ShiftDefinition[]
  shiftSchedules          ShiftSchedule[]
  shiftAssignments        ShiftAssignment[]

  // Relazioni Fase 4.4 - Timbratura
  attendancePolicy    AttendancePolicy?
  attendanceRecords   AttendanceRecord[]
  attendanceAnomalies AttendanceAnomaly[]

  // Relazione con fatture elettroniche
  electronicInvoices ElectronicInvoice[]

  // Relazione con target budget mensili
  budgetTargets BudgetTarget[]

  // Relazioni riconciliazione bancaria
  bankTransactions BankTransaction[]
  importBatches    ImportBatch[]

  // Relazioni cash flow previsionale
  recurringExpenses RecurringExpense[]
  cashFlowSetting   CashFlowSetting?

  @@map("venues")
}

model CashStationTemplate {
  id          String  @id @default(cuid())
  venue       Venue   @relation(fields: [venueId], references: [id])
  venueId     String  @map("venue_id")
  name        String // "BAR", "CASSA 1", "TAVOLI", etc.
  position    Int     @default(0)
  isActive    Boolean @default(true) @map("is_active")
  isEventOnly Boolean @default(false) @map("is_event_only") // Solo per eventi (es. CASSA 2, CASSA 3)

  @@map("cash_station_templates")
}

// ==================== CHIUSURA CASSA ====================

model DailyClosure {
  id      String   @id @default(cuid())
  venue   Venue    @relation(fields: [venueId], references: [id])
  venueId String   @map("venue_id")
  date    DateTime @db.Date

  // Meteo (opzionale)
  weatherMorning   String? @map("weather_morning")
  weatherAfternoon String? @map("weather_afternoon")
  weatherEvening   String? @map("weather_evening")

  // Note
  notes String? @db.Text

  // Evento
  isEvent   Boolean @default(false) @map("is_event")
  eventName String? @map("event_name")

  // Workflow
  status         ClosureStatus @default(DRAFT)
  submittedBy    User?         @relation("SubmittedBy", fields: [submittedById], references: [id])
  submittedById  String?       @map("submitted_by")
  submittedAt    DateTime?     @map("submitted_at")
  validatedBy    User?         @relation("ValidatedBy", fields: [validatedById], references: [id])
  validatedById  String?       @map("validated_by")
  validatedAt    DateTime?     @map("validated_at")
  rejectionNotes String?       @map("rejection_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relazioni
  stations       CashStation[]
  partials       HourlyPartial[]
  expenses       DailyExpense[]
  attendance     DailyAttendance[]
  journalEntries JournalEntry[]

  @@unique([venueId, date])
  @@map("daily_closures")
}

enum ClosureStatus {
  DRAFT
  SUBMITTED
  VALIDATED
  REJECTED
}

model CashStation {
  id        String       @id @default(cuid())
  closure   DailyClosure @relation(fields: [closureId], references: [id], onDelete: Cascade)
  closureId String       @map("closure_id")
  name      String // "BAR", "CASSA 1", etc.
  position  Int          @default(0)

  // Incassi
  receiptAmount   Decimal @default(0) @map("receipt_amount") @db.Decimal(10, 2) // Corrispettivo
  receiptVat      Decimal @default(0) @map("receipt_vat") @db.Decimal(10, 2) // IVA scorporata
  invoiceAmount   Decimal @default(0) @map("invoice_amount") @db.Decimal(10, 2) // Fatture
  invoiceVat      Decimal @default(0) @map("invoice_vat") @db.Decimal(10, 2)
  suspendedAmount Decimal @default(0) @map("suspended_amount") @db.Decimal(10, 2) // Sospesi
  cashAmount      Decimal @default(0) @map("cash_amount") @db.Decimal(10, 2) // Contanti
  posAmount       Decimal @default(0) @map("pos_amount") @db.Decimal(10, 2) // POS

  // Calcolati (possono essere stored per performance)
  totalAmount      Decimal @default(0) @map("total_amount") @db.Decimal(10, 2) // cash + pos
  nonReceiptAmount Decimal @default(0) @map("non_receipt_amount") @db.Decimal(10, 2) // totale - corrispettivo

  // Fondo cassa
  floatAmount Decimal @default(114.00) @map("float_amount") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")

  cashCount CashCount?

  @@map("cash_stations")
}

model CashCount {
  id        String      @id @default(cuid())
  station   CashStation @relation(fields: [stationId], references: [id], onDelete: Cascade)
  stationId String      @unique @map("station_id")

  // Banconote
  bills500 Int @default(0) @map("bills_500")
  bills200 Int @default(0) @map("bills_200")
  bills100 Int @default(0) @map("bills_100")
  bills50  Int @default(0) @map("bills_50")
  bills20  Int @default(0) @map("bills_20")
  bills10  Int @default(0) @map("bills_10")
  bills5   Int @default(0) @map("bills_5")

  // Monete
  coins2   Int @default(0) @map("coins_2")
  coins1   Int @default(0) @map("coins_1")
  coins050 Int @default(0) @map("coins_050")
  coins020 Int @default(0) @map("coins_020")
  coins010 Int @default(0) @map("coins_010")
  coins005 Int @default(0) @map("coins_005")
  coins002 Int @default(0) @map("coins_002")
  coins001 Int @default(0) @map("coins_001")

  // Totali calcolati
  totalCounted  Decimal @default(0) @map("total_counted") @db.Decimal(10, 2)
  expectedTotal Decimal @default(0) @map("expected_total") @db.Decimal(10, 2)
  difference    Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("cash_counts")
}

model HourlyPartial {
  id        String       @id @default(cuid())
  closure   DailyClosure @relation(fields: [closureId], references: [id], onDelete: Cascade)
  closureId String       @map("closure_id")
  timeSlot  String // "16:00", "21:00"

  receiptProgressive Decimal @default(0) @map("receipt_progressive") @db.Decimal(10, 2)
  posProgressive     Decimal @default(0) @map("pos_progressive") @db.Decimal(10, 2)
  coffeeCounter      Int?    @map("coffee_counter")
  coffeeDelta        Int?    @map("coffee_delta")
  weather            String?

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([closureId, timeSlot])
  @@map("hourly_partials")
}

// ==================== USCITE E SPESE ====================

model DailyExpense {
  id        String       @id @default(cuid())
  closure   DailyClosure @relation(fields: [closureId], references: [id], onDelete: Cascade)
  closureId String       @map("closure_id")

  payee        String // Beneficiario
  description  String? // Causale
  documentRef  String?      @map("document_ref")
  documentType DocumentType @default(NONE) @map("document_type")
  amount       Decimal      @db.Decimal(10, 2)
  vatAmount    Decimal?     @map("vat_amount") @db.Decimal(10, 2)

  account   Account? @relation(fields: [accountId], references: [id])
  accountId String?  @map("account_id")

  isPaid Boolean @default(true) @map("is_paid")
  paidBy String? @map("paid_by") // Chi ha anticipato (es. "LUCA")

  position  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("daily_expenses")
}

enum DocumentType {
  FATTURA
  DDT
  RICEVUTA
  PERSONALE
  NONE
}

// ==================== PRESENZE ====================

model DailyAttendance {
  id        String       @id @default(cuid())
  closure   DailyClosure @relation(fields: [closureId], references: [id], onDelete: Cascade)
  closureId String       @map("closure_id")
  user      User         @relation(fields: [userId], references: [id])
  userId    String       @map("user_id")

  shift      Shift
  hours      Decimal? @db.Decimal(4, 1) // NULL se codice
  statusCode String?  @map("status_code") // "FE", "R", "Z", "C"
  hourlyRate Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  totalPay   Decimal? @map("total_pay") @db.Decimal(10, 2)
  isPaid     Boolean  @default(false) @map("is_paid")
  notes      String?

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([closureId, userId, shift])
  @@map("daily_attendance")
}

enum Shift {
  MORNING
  EVENING
}

// ==================== PIANO DEI CONTI ====================

model Account {
  id        String      @id @default(cuid())
  code      String      @unique
  name      String
  type      AccountType
  category  String?
  parent    Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  parentId  String?     @map("parent_id")
  children  Account[]   @relation("AccountHierarchy")
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime    @default(now()) @map("created_at")

  expenses           DailyExpense[]
  journalEntries     JournalEntry[]
  counterpartEntries JournalEntry[]        @relation("Counterpart")
  suppliers          Supplier[]
  budgetLines        BudgetLine[]
  budgetMapping      AccountBudgetMapping?

  // Relazione con fatture elettroniche
  electronicInvoices ElectronicInvoice[]

  // Relazione cash flow previsionale
  recurringExpenses RecurringExpense[]

  @@map("accounts")
}

enum AccountType {
  RICAVO
  COSTO
  ATTIVO
  PASSIVO
}

// ==================== PRIMA NOTA ====================

model JournalEntry {
  id      String   @id @default(cuid())
  venue   Venue    @relation(fields: [venueId], references: [id])
  venueId String   @map("venue_id")
  date    DateTime @db.Date

  registerType RegisterType @map("register_type")
  documentRef  String?      @map("document_ref")
  documentType String?      @map("document_type")
  description  String

  debitAmount  Decimal? @map("debit_amount") @db.Decimal(10, 2) // Dare
  creditAmount Decimal? @map("credit_amount") @db.Decimal(10, 2) // Avere
  vatAmount    Decimal? @map("vat_amount") @db.Decimal(10, 2)

  account       Account? @relation(fields: [accountId], references: [id])
  accountId     String?  @map("account_id")
  counterpart   Account? @relation("Counterpart", fields: [counterpartId], references: [id])
  counterpartId String?  @map("counterpart_id")

  // Collegamenti
  closure   DailyClosure? @relation(fields: [closureId], references: [id])
  closureId String?       @map("closure_id")

  // Saldo progressivo (calcolato)
  runningBalance Decimal? @map("running_balance") @db.Decimal(12, 2)

  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relazione con fattura elettronica (opzionale)
  electronicInvoice ElectronicInvoice?

  // Relazione con transazione bancaria (riconciliazione)
  bankTransaction BankTransaction?

  @@map("journal_entries")
}

enum RegisterType {
  CASH
  BANK
}

// ==================== SALDI ====================

model RegisterBalance {
  id           String       @id @default(cuid())
  venue        Venue        @relation(fields: [venueId], references: [id])
  venueId      String       @map("venue_id")
  registerType RegisterType @map("register_type")
  date         DateTime     @db.Date

  openingBalance Decimal @map("opening_balance") @db.Decimal(12, 2)
  totalDebits    Decimal @map("total_debits") @db.Decimal(12, 2)
  totalCredits   Decimal @map("total_credits") @db.Decimal(12, 2)
  closingBalance Decimal @map("closing_balance") @db.Decimal(12, 2)

  @@unique([venueId, registerType, date])
  @@map("register_balances")
}

// ==================== FORNITORI (per autocompletamento) ====================

model Supplier {
  id               String   @id @default(cuid())
  name             String
  vatNumber        String?  @map("vat_number")
  fiscalCode       String?  @map("fiscal_code") // Codice fiscale
  address          String?
  city             String?
  province         String?
  postalCode       String?  @map("postal_code")
  defaultAccount   Account? @relation(fields: [defaultAccountId], references: [id])
  defaultAccountId String?  @map("default_account_id")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  // Relazione con fatture elettroniche
  electronicInvoices ElectronicInvoice[]

  @@map("suppliers")
}

// ==================== BUDGET MODULE ====================

model Budget {
  id      String       @id @default(cuid())
  venue   Venue        @relation(fields: [venueId], references: [id])
  venueId String       @map("venue_id")
  year    Int
  name    String?
  status  BudgetStatus @default(DRAFT)
  notes   String?      @db.Text

  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  lines  BudgetLine[]
  alerts BudgetAlert[]

  @@unique([venueId, year])
  @@map("budgets")
}

// === CATEGORIE BUDGET PERSONALIZZABILI ===

model BudgetCategory {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  code String // Es: "COSTI_PERSONALE", "FOOD_COST", "RICAVI_BAR"
  name String // Nome visualizzato

  // Gerarchia (categorie raggruppabili)
  parent   BudgetCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  parentId String?          @map("parent_id")
  children BudgetCategory[] @relation("CategoryHierarchy")

  displayOrder Int @default(0) @map("display_order")

  // Tipo categoria per calcoli e visualizzazione
  categoryType BudgetCategoryType @default(COST) @map("category_type")

  // Aspetto visivo
  color String? // Colore HEX (#3B82F6)
  icon  String? // Icona emoji o classe icona

  // Benchmark (% target su ricavi)
  benchmarkPercentage   Decimal?            @map("benchmark_percentage") @db.Decimal(5, 2)
  benchmarkComparison   BenchmarkComparison @default(LESS_THAN) @map("benchmark_comparison")
  alertThresholdPercent Decimal?            @map("alert_threshold_percent") @db.Decimal(5, 2) // Soglia alert (default 10%)

  description String? @db.Text

  // Categorie di sistema (non eliminabili)
  isSystem Boolean @default(false) @map("is_system")
  isActive Boolean @default(true) @map("is_active")

  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relazioni
  accountMappings AccountBudgetMapping[]
  budgetLines     BudgetLine[]
  alerts          BudgetAlert[]

  @@unique([venueId, code])
  @@index([venueId, categoryType])
  @@map("budget_categories")
}

enum BudgetCategoryType {
  REVENUE // Ricavi
  COST // Costi
  KPI // Indicatori calcolati (margini, %)
  TAX // Imposte e contributi
  INVESTMENT // Investimenti/ammortamenti
  VAT // IVA
}

enum BenchmarkComparison {
  LESS_THAN // Il valore deve essere < benchmark (es. costi)
  GREATER_THAN // Il valore deve essere > benchmark (es. margine)
  EQUAL // Il valore deve essere = benchmark
}

// Mapping tra conti del piano dei conti e categorie budget
model AccountBudgetMapping {
  id String @id @default(cuid())

  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique @map("account_id") // Un conto può appartenere a una sola categoria

  budgetCategory   BudgetCategory @relation(fields: [budgetCategoryId], references: [id], onDelete: Cascade)
  budgetCategoryId String         @map("budget_category_id")

  // Per override del tipo movimento (in casi particolari)
  includeInBudget Boolean @default(true) @map("include_in_budget")

  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([budgetCategoryId])
  @@map("account_budget_mappings")
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model BudgetLine {
  id        String  @id @default(cuid())
  budget    Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId  String  @map("budget_id")
  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @map("account_id")

  // Categoria budget (opzionale, per raggruppamento)
  budgetCategory   BudgetCategory? @relation(fields: [budgetCategoryId], references: [id])
  budgetCategoryId String?         @map("budget_category_id")

  // Valori mensili
  jan Decimal @default(0) @db.Decimal(12, 2)
  feb Decimal @default(0) @db.Decimal(12, 2)
  mar Decimal @default(0) @db.Decimal(12, 2)
  apr Decimal @default(0) @db.Decimal(12, 2)
  may Decimal @default(0) @db.Decimal(12, 2)
  jun Decimal @default(0) @db.Decimal(12, 2)
  jul Decimal @default(0) @db.Decimal(12, 2)
  aug Decimal @default(0) @db.Decimal(12, 2)
  sep Decimal @default(0) @db.Decimal(12, 2)
  oct Decimal @default(0) @db.Decimal(12, 2)
  nov Decimal @default(0) @db.Decimal(12, 2)
  dec Decimal @default(0) @db.Decimal(12, 2)

  annualTotal Decimal @default(0) @map("annual_total") @db.Decimal(12, 2)
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([budgetId, accountId])
  @@index([budgetCategoryId])
  @@map("budget_lines")
}

model BudgetAlert {
  id        String  @id @default(cuid())
  budget    Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId  String  @map("budget_id")
  accountId String? @map("account_id")

  // Relazione con categoria budget (per alert a livello categoria)
  category   BudgetCategory? @relation(fields: [categoryId], references: [id])
  categoryId String?         @map("category_id")

  month     Int?

  alertType       BudgetAlertType @map("alert_type")
  budgetAmount    Decimal         @map("budget_amount") @db.Decimal(12, 2)
  actualAmount    Decimal         @map("actual_amount") @db.Decimal(12, 2)
  varianceAmount  Decimal         @map("variance_amount") @db.Decimal(12, 2)
  variancePercent Decimal         @map("variance_percent") @db.Decimal(5, 2)

  status         AlertStatus @default(ACTIVE)
  acknowledgedBy String?     @map("acknowledged_by")
  acknowledgedAt DateTime?   @map("acknowledged_at")
  message        String?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([categoryId])
  @@map("budget_alerts")
}

enum BudgetAlertType {
  OVER_BUDGET
  UNDER_REVENUE
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

// ==================== TARGET BUDGET MENSILI ====================

model BudgetTarget {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  year  Int
  month Int // 1-12

  targetRevenue Decimal @map("target_revenue") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([venueId, year, month])
  @@map("budget_targets")
}

// ==================== SALDI INIZIALI ====================

model InitialBalance {
  id          String   @id @default(cuid())
  venue       Venue    @relation(fields: [venueId], references: [id])
  venueId     String   @map("venue_id")
  year        Int
  cashBalance Decimal  @default(0) @map("cash_balance") @db.Decimal(12, 2)
  bankBalance Decimal  @default(0) @map("bank_balance") @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([venueId, year])
  @@map("initial_balances")
}

// ==================== FASE 4: VINCOLI DIPENDENTI ====================

model EmployeeConstraint {
  id      String  @id @default(cuid())
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String  @map("user_id")
  venue   Venue?  @relation(fields: [venueId], references: [id])
  venueId String? @map("venue_id")

  constraintType ConstraintType @map("constraint_type")
  config         Json // Configurazione flessibile del vincolo

  validFrom DateTime? @map("valid_from") @db.Date
  validTo   DateTime? @map("valid_to") @db.Date

  priority         Int     @default(5) // 1-10
  isHardConstraint Boolean @default(true) @map("is_hard_constraint")

  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  notes       String?

  @@index([userId])
  @@index([constraintType])
  @@map("employee_constraints")
}

enum ConstraintType {
  AVAILABILITY // Disponibilità turni/giorni
  MAX_HOURS // Max ore settimanali/giornaliere
  MIN_REST // Riposo minimo tra turni
  PREFERRED_SHIFT // Turno preferito (soft)
  BLOCKED_DAY // Giorno bloccato fisso
  SKILL_REQUIRED // Competenze richieste
  CONSECUTIVE_DAYS // Max giorni consecutivi
}

model RelationshipConstraint {
  id      String  @id @default(cuid())
  venue   Venue?  @relation(fields: [venueId], references: [id])
  venueId String? @map("venue_id")

  constraintType RelConstraintType @map("constraint_type")
  config         Json // Configurazione del vincolo

  validFrom DateTime? @map("valid_from") @db.Date
  validTo   DateTime? @map("valid_to") @db.Date

  priority         Int     @default(5)
  isHardConstraint Boolean @default(true) @map("is_hard_constraint")

  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  notes       String?

  users RelationshipConstraintUser[]

  @@map("relationship_constraints")
}

enum RelConstraintType {
  SAME_DAY_OFF // Giorno libero comune (es. coppia)
  NEVER_TOGETHER // Mai stesso turno
  ALWAYS_TOGETHER // Sempre insieme (es. senior con junior)
  MIN_OVERLAP // Minimo overlap per passaggio consegne
  MAX_TOGETHER // Massimo ore insieme a settimana
}

model RelationshipConstraintUser {
  constraint   RelationshipConstraint @relation(fields: [constraintId], references: [id], onDelete: Cascade)
  constraintId String                 @map("constraint_id")
  user         User                   @relation(fields: [userId], references: [id])
  userId       String                 @map("user_id")

  @@id([constraintId, userId])
  @@map("relationship_constraint_users")
}

// ==================== FASE 4: DEFINIZIONI TURNI ====================

model ShiftDefinition {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  name  String // "Mattina", "Aperitivo", "Sera"
  code  String // "M", "A", "S"
  color String? // HEX color (#FCD34D)

  startTime    DateTime @map("start_time") @db.Time()
  endTime      DateTime @map("end_time") @db.Time()
  breakMinutes Int      @default(0) @map("break_minutes")

  minStaff       Int      @default(1) @map("min_staff")
  maxStaff       Int?     @map("max_staff")
  requiredSkills String[] @default([]) @map("required_skills")

  rateMultiplier Decimal @default(1.0) @map("rate_multiplier") @db.Decimal(3, 2)

  isActive Boolean @default(true) @map("is_active")
  position Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")

  assignments ShiftAssignment[]

  @@unique([venueId, code])
  @@map("shift_definitions")
}

// ==================== FASE 4: PIANIFICAZIONE TURNI ====================

model ShiftSchedule {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  name      String? // "Settimana 6-12 Gen 2026"
  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date

  status ScheduleStatus @default(DRAFT)

  // Generazione AI
  generationParams Json?    @map("generation_params")
  generationLog    Json?    @map("generation_log")
  generationScore  Decimal? @map("generation_score") @db.Decimal(5, 2)

  // Workflow
  createdById   String?   @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  publishedById String?   @map("published_by")
  publishedAt   DateTime? @map("published_at")

  notes String?

  assignments ShiftAssignment[]

  @@unique([venueId, startDate, endDate])
  @@map("shift_schedules")
}

enum ScheduleStatus {
  DRAFT
  GENERATED
  REVIEW
  PUBLISHED
  ARCHIVED
}

model ShiftAssignment {
  id         String        @id @default(cuid())
  schedule   ShiftSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId String        @map("schedule_id")

  user              User             @relation(fields: [userId], references: [id])
  userId            String           @map("user_id")
  shiftDefinition   ShiftDefinition? @relation(fields: [shiftDefinitionId], references: [id])
  shiftDefinitionId String?          @map("shift_definition_id")

  date         DateTime @db.Date
  startTime    DateTime @map("start_time") @db.Time()
  endTime      DateTime @map("end_time") @db.Time()
  breakMinutes Int      @default(0) @map("break_minutes")

  venue       Venue   @relation(fields: [venueId], references: [id])
  venueId     String  @map("venue_id")
  workStation String? @map("work_station")

  status AssignmentStatus @default(SCHEDULED)

  // Per scambi turno (futuro)
  swapRequestedById String?     @map("swap_requested_by")
  swapWithUserId    String?     @map("swap_with_user_id")
  swapStatus        SwapStatus? @map("swap_status")

  // Calcolo costi
  hoursScheduled    Decimal? @map("hours_scheduled") @db.Decimal(4, 2)
  hourlyRateApplied Decimal? @map("hourly_rate_applied") @db.Decimal(10, 2)
  costEstimated     Decimal? @map("cost_estimated") @db.Decimal(10, 2)

  // Effettivo (da presenze)
  actualStart DateTime? @map("actual_start") @db.Time()
  actualEnd   DateTime? @map("actual_end") @db.Time()
  hoursWorked Decimal?  @map("hours_worked") @db.Decimal(4, 2)
  costActual  Decimal?  @map("cost_actual") @db.Decimal(10, 2)

  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relazioni Fase 4.4 - Timbratura
  attendanceRecords   AttendanceRecord[]
  attendanceAnomalies AttendanceAnomaly[]

  @@unique([scheduleId, userId, date, startTime])
  @@index([date])
  @@index([userId])
  @@map("shift_assignments")
}

enum AssignmentStatus {
  SCHEDULED // Pianificato
  CONFIRMED // Confermato dal dipendente
  SWAPPED // Scambiato
  ABSENT // Assente
  WORKED // Lavorato
}

enum SwapStatus {
  PENDING // In attesa conferma collega
  APPROVED // Approvato
  REJECTED // Rifiutato
}

// ==================== FASE 4: FERIE E PERMESSI ====================

model LeaveType {
  id    String  @id @default(cuid())
  code  String  @unique // "FE", "ROL", "MA", etc.
  name  String // "Ferie", "Permesso ROL", "Malattia"
  color String?
  icon  String?

  requiresApproval Boolean @default(true) @map("requires_approval")
  requiresDocument Boolean @default(false) @map("requires_document")
  maxDaysAdvance   Int?    @map("max_days_advance")
  minDaysAdvance   Int?    @map("min_days_advance")

  affectsAccrual Boolean @default(true) @map("affects_accrual")
  paid           Boolean @default(true)

  isActive Boolean @default(true) @map("is_active")

  requests LeaveRequest[]
  balances LeaveBalance[]

  @@map("leave_types")
}

model LeaveRequest {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String    @map("user_id")
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])
  leaveTypeId String    @map("leave_type_id")

  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date

  isPartialDay Boolean   @default(false) @map("is_partial_day")
  startTime    DateTime? @map("start_time") @db.Time()
  endTime      DateTime? @map("end_time") @db.Time()

  daysRequested  Decimal? @map("days_requested") @db.Decimal(4, 2)
  hoursRequested Decimal? @map("hours_requested") @db.Decimal(5, 2)

  status LeaveStatus @default(PENDING)

  requestedAt DateTime @default(now()) @map("requested_at")

  approvedBy      User?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedById    String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  rejectionReason String?   @map("rejection_reason")

  documentUrl        String?   @map("document_url")
  documentUploadedAt DateTime? @map("document_uploaded_at")

  notes        String?
  managerNotes String? @map("manager_notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("leave_requests")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LeaveBalance {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String    @map("user_id")
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])
  leaveTypeId String    @map("leave_type_id")
  year        Int

  accrued     Decimal @default(0) @db.Decimal(6, 2) // Maturato
  used        Decimal @default(0) @db.Decimal(6, 2) // Usato
  pending     Decimal @default(0) @db.Decimal(6, 2) // In attesa approvazione
  carriedOver Decimal @default(0) @map("carried_over") @db.Decimal(6, 2) // Riporto anno precedente

  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, leaveTypeId, year])
  @@map("leave_balances")
}

// ==================== FASE 4.4: TIMBRATURA ====================

enum PunchType {
  IN // Ingresso
  OUT // Uscita
  BREAK_START // Inizio pausa
  BREAK_END // Fine pausa
}

enum PunchMethod {
  APP // Timbratura da app mobile con GPS
  WEB // Timbratura da dashboard web
  QR_CODE // Scansione QR code (futuro)
  MANUAL // Inserimento manuale manager
}

enum AnomalyType {
  EARLY_CLOCK_IN // Timbrato troppo presto
  LATE_CLOCK_IN // Timbrato in ritardo
  EARLY_CLOCK_OUT // Uscito troppo presto
  LATE_CLOCK_OUT // Uscito tardi (straordinario)
  OUTSIDE_LOCATION // Fuori dal raggio GPS
  MISSING_CLOCK_OUT // Manca uscita
  OVERTIME // Ore extra non autorizzate
  MISSING_BREAK // Pausa non registrata
  SHORT_BREAK // Pausa troppo corta
}

enum AnomalyStatus {
  PENDING // Da verificare
  APPROVED // Approvata dal manager
  REJECTED // Rifiutata
  AUTO_FIXED // Corretta automaticamente
}

model AttendanceRecord {
  id String @id @default(cuid())

  // Relazioni
  user         User             @relation(fields: [userId], references: [id])
  userId       String           @map("user_id")
  venue        Venue            @relation(fields: [venueId], references: [id])
  venueId      String           @map("venue_id")
  assignment   ShiftAssignment? @relation(fields: [assignmentId], references: [id])
  assignmentId String?          @map("assignment_id")

  // Dati timbratura
  punchType   PunchType   @map("punch_type")
  punchMethod PunchMethod @default(APP) @map("punch_method")
  punchedAt   DateTime    @default(now()) @map("punched_at")

  // Geolocalizzazione
  latitude          Decimal? @db.Decimal(9, 6)
  longitude         Decimal? @db.Decimal(9, 6)
  accuracy          Decimal? @db.Decimal(6, 2) // Precisione GPS in metri
  distanceFromVenue Decimal? @map("distance_from_venue") @db.Decimal(8, 2)
  isWithinRadius    Boolean  @default(true) @map("is_within_radius")

  // Metadata
  deviceInfo String? @map("device_info")
  ipAddress  String? @map("ip_address")
  notes      String?

  // Inserimento manuale
  isManual          Boolean @default(false) @map("is_manual")
  manualEntryBy     String? @map("manual_entry_by")
  manualEntryReason String? @map("manual_entry_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relazioni inverse
  anomalies AttendanceAnomaly[]

  @@index([userId, punchedAt])
  @@index([venueId, punchedAt])
  @@index([assignmentId])
  @@map("attendance_records")
}

model AttendancePolicy {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @unique @map("venue_id")

  // Raggio geolocalizzazione
  geoFenceRadius       Int     @default(100) @map("geo_fence_radius") // Metri
  requireGeolocation   Boolean @default(true) @map("require_geolocation")
  blockOutsideLocation Boolean @default(false) @map("block_outside_location")

  // Tolleranze temporali (minuti)
  earlyClockInMinutes  Int @default(15) @map("early_clock_in_minutes")
  lateClockInMinutes   Int @default(10) @map("late_clock_in_minutes")
  earlyClockOutMinutes Int @default(5) @map("early_clock_out_minutes")
  lateClockOutMinutes  Int @default(30) @map("late_clock_out_minutes")

  // Auto clock-out
  autoClockOutEnabled Boolean @default(true) @map("auto_clock_out_enabled")
  autoClockOutHours   Int     @default(12) @map("auto_clock_out_hours")

  // Pause
  requireBreakPunch Boolean @default(false) @map("require_break_punch")
  minBreakMinutes   Int     @default(30) @map("min_break_minutes")

  // Notifiche
  notifyOnAnomaly    Boolean @default(true) @map("notify_on_anomaly")
  notifyManagerEmail String? @map("notify_manager_email")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("attendance_policies")
}

model AttendanceAnomaly {
  id String @id @default(cuid())

  // Relazioni
  user         User              @relation(fields: [userId], references: [id])
  userId       String            @map("user_id")
  venue        Venue             @relation(fields: [venueId], references: [id])
  venueId      String            @map("venue_id")
  record       AttendanceRecord? @relation(fields: [recordId], references: [id])
  recordId     String?           @map("record_id")
  assignment   ShiftAssignment?  @relation(fields: [assignmentId], references: [id])
  assignmentId String?           @map("assignment_id")

  // Dati anomalia
  anomalyType AnomalyType   @map("anomaly_type")
  status      AnomalyStatus @default(PENDING)
  date        DateTime      @db.Date
  description String?

  // Valori
  expectedValue     String? @map("expected_value") // Es: "09:00"
  actualValue       String? @map("actual_value") // Es: "09:25"
  differenceMinutes Int?    @map("difference_minutes")

  // Risoluzione
  resolvedBy      String?   @map("resolved_by")
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @map("resolution_notes")

  // Impatto economico
  hoursAffected Decimal? @map("hours_affected") @db.Decimal(4, 2)
  costImpact    Decimal? @map("cost_impact") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, date])
  @@index([venueId, status])
  @@map("attendance_anomalies")
}

// ==================== FASE 5.2: NOTIFICHE PUSH ====================

model NotificationPreference {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @map("user_id")

  // Canali
  pushEnabled  Boolean @default(true) @map("push_enabled")
  emailEnabled Boolean @default(false) @map("email_enabled")

  // Tipi notifica - Turni
  newShiftPublished    Boolean @default(true) @map("new_shift_published")
  shiftReminder        Boolean @default(true) @map("shift_reminder")
  shiftReminderMinutes Int     @default(60) @map("shift_reminder_minutes") // Minuti prima
  shiftSwapRequest     Boolean @default(true) @map("shift_swap_request")

  // Tipi notifica - Presenze
  anomalyCreated  Boolean @default(true) @map("anomaly_created")
  anomalyResolved Boolean @default(true) @map("anomaly_resolved")

  // Tipi notifica - Ferie
  leaveApproved Boolean @default(true) @map("leave_approved")
  leaveRejected Boolean @default(true) @map("leave_rejected")
  leaveReminder Boolean @default(true) @map("leave_reminder")

  // Tipi notifica - Manager
  newLeaveRequest Boolean @default(true) @map("new_leave_request")
  staffAnomaly    Boolean @default(true) @map("staff_anomaly")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

model NotificationLog {
  id     String @id @default(cuid())
  userId String @map("user_id")

  type  NotificationType
  title String
  body  String
  data  Json? // Payload aggiuntivo

  channel NotificationChannel @default(PUSH)
  status  NotificationStatus  @default(SENT)

  sentAt      DateTime  @default(now()) @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  readAt      DateTime? @map("read_at")

  errorMsg String? @map("error_msg")

  // Riferimenti opzionali
  referenceId   String? @map("reference_id") // ID dell'entità correlata
  referenceType String? @map("reference_type") // "LeaveRequest", "ShiftSchedule", etc.

  @@index([userId, sentAt])
  @@index([type, status])
  @@map("notification_logs")
}

enum NotificationType {
  SHIFT_PUBLISHED // Nuovi turni pubblicati
  SHIFT_REMINDER // Promemoria turno
  SHIFT_SWAP_REQUEST // Richiesta scambio turno
  SHIFT_SWAP_APPROVED // Scambio approvato
  SHIFT_SWAP_REJECTED // Scambio rifiutato
  ANOMALY_CREATED // Nuova anomalia presenze
  ANOMALY_RESOLVED // Anomalia risolta
  LEAVE_APPROVED // Ferie approvate
  LEAVE_REJECTED // Ferie rifiutate
  LEAVE_REMINDER // Promemoria ferie imminenti
  NEW_LEAVE_REQUEST // Nuova richiesta ferie (manager)
  STAFF_ANOMALY // Anomalia staff (manager)
  GENERAL // Notifica generica
}

enum NotificationChannel {
  PUSH
  EMAIL
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

model PushSubscription {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // FCM Token
  fcmToken String @unique @map("fcm_token")

  // Metadata dispositivo
  deviceName  String? @map("device_name")
  deviceType  String? @map("device_type") // "ios", "android", "web"
  browserName String? @map("browser_name")

  isActive Boolean @default(true) @map("is_active")

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  lastUsedAt DateTime? @map("last_used_at")

  @@index([userId])
  @@map("push_subscriptions")
}

// ==================== FASE 3: FATTURE ELETTRONICHE SDI ====================

enum InvoiceStatus {
  IMPORTED // Appena importata
  MATCHED // Fornitore identificato
  CATEGORIZED // Conto assegnato
  RECORDED // Registrata in prima nota
  PAID // Pagata
}

model ElectronicInvoice {
  id String @id @default(cuid())

  // Identificativi SDI
  sdiId         String? @unique @map("sdi_id") // Identificativo SDI
  invoiceNumber String  @map("invoice_number") // Numero fattura
  invoiceDate   DateTime @map("invoice_date") @db.Date // Data fattura

  // Fornitore
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  supplierId  String?   @map("supplier_id")
  supplierVat String    @map("supplier_vat") // P.IVA fornitore (per matching)
  supplierName String   @map("supplier_name") // Denominazione fornitore

  // Importi
  totalAmount Decimal @map("total_amount") @db.Decimal(10, 2) // Totale documento
  vatAmount   Decimal @map("vat_amount") @db.Decimal(10, 2) // Totale IVA
  netAmount   Decimal @map("net_amount") @db.Decimal(10, 2) // Imponibile

  // Stato elaborazione
  status InvoiceStatus @default(IMPORTED)

  // Categorizzazione
  account   Account? @relation(fields: [accountId], references: [id])
  accountId String?  @map("account_id")

  // Metadata XML
  xmlContent String? @map("xml_content") @db.Text // XML originale
  fileName   String? @map("file_name")

  // Timestamp elaborazione
  importedAt  DateTime  @default(now()) @map("imported_at")
  processedAt DateTime? @map("processed_at")
  recordedAt  DateTime? @map("recorded_at")

  // Relazione con prima nota
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
  journalEntryId String?       @unique @map("journal_entry_id")

  // Scadenze pagamento
  deadlines InvoiceDeadline[]

  // Sede
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  // Audit
  createdBy String? @map("created_by")
  notes     String? @db.Text

  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([venueId])
  @@map("electronic_invoices")
}

model InvoiceDeadline {
  id String @id @default(cuid())

  invoice   ElectronicInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String            @map("invoice_id")

  dueDate       DateTime @map("due_date") @db.Date
  amount        Decimal  @db.Decimal(10, 2)
  isPaid        Boolean  @default(false) @map("is_paid")
  paidAt        DateTime? @map("paid_at")
  paymentMethod String?  @map("payment_method") // Bonifico, RiBa, etc.

  createdAt DateTime @default(now()) @map("created_at")

  @@index([dueDate])
  @@index([isPaid])
  @@map("invoice_deadlines")
}

// ==================== RICONCILIAZIONE BANCARIA ====================

model BankTransaction {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  // Dati da estratto conto
  transactionDate DateTime  @map("transaction_date") @db.Date
  valueDate       DateTime? @map("value_date") @db.Date
  description     String    @db.VarChar(500)
  amount          Decimal   @db.Decimal(12, 2) // + entrata, - uscita
  balanceAfter    Decimal?  @map("balance_after") @db.Decimal(12, 2)

  // Metadati import
  bankReference String?      @map("bank_reference") @db.VarChar(100)
  importBatch   ImportBatch? @relation(fields: [importBatchId], references: [id])
  importBatchId String?      @map("import_batch_id")
  importedAt    DateTime     @default(now()) @map("imported_at")
  importSource  ImportSource @default(CSV) @map("import_source")

  // Riconciliazione
  status          ReconciliationStatus @default(PENDING)
  matchedEntry    JournalEntry?        @relation(fields: [matchedEntryId], references: [id])
  matchedEntryId  String?              @unique @map("matched_entry_id")
  matchConfidence Decimal?             @map("match_confidence") @db.Decimal(3, 2) // 0.00-1.00
  reconciledBy    String?              @map("reconciled_by")
  reconciledAt    DateTime?            @map("reconciled_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([venueId, bankReference])
  @@index([venueId, status])
  @@index([transactionDate])
  @@index([importBatchId])
  @@map("bank_transactions")
}

model ImportBatch {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  filename    String?
  source      ImportSource
  recordCount Int          @map("record_count")

  // Statistiche import
  duplicatesSkipped Int @default(0) @map("duplicates_skipped")
  errorsCount       Int @default(0) @map("errors_count")

  importedBy String   @map("imported_by")
  importedAt DateTime @default(now()) @map("imported_at")

  transactions BankTransaction[]

  @@index([venueId])
  @@index([importedAt])
  @@map("import_batches")
}

enum ImportSource {
  CSV
  XLSX
  CBI_XML    // ISO 20022 XML format (CAMT.053)
  CBI_TXT    // CBI fixed-position TXT format
  PSD2_FABRICK
  PSD2_TINK
  MANUAL
}

enum ReconciliationStatus {
  PENDING   // Non ancora processato
  MATCHED   // Match automatico confermato
  TO_REVIEW // Match con confidence < 90%
  MANUAL    // Assegnato manualmente
  IGNORED   // Ignorato dall'utente
  UNMATCHED // Nessun match trovato
}

// ==================== CASH FLOW PREVISIONALE ====================

model RecurringExpense {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @map("venue_id")

  name        String             // "Affitto", "Utenze", "Stipendi"
  description String?
  amount      Decimal            @db.Decimal(12, 2)
  frequency   ExpenseFrequency
  dayOfMonth  Int?               @map("day_of_month") // 1-31 per mensile
  dayOfWeek   Int?               @map("day_of_week") // 0-6 per settimanale
  startDate   DateTime?          @map("start_date") @db.Date
  endDate     DateTime?          @map("end_date") @db.Date
  isActive    Boolean            @default(true) @map("is_active")

  // Collegamento opzionale a conto contabile
  account   Account? @relation(fields: [accountId], references: [id])
  accountId String?  @map("account_id")

  // Metadati
  category  String? // "Personale", "Utenze", "Affitto", "Fornitori", "Tasse"
  createdBy String  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([venueId, isActive])
  @@index([frequency])
  @@map("recurring_expenses")
}

enum ExpenseFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model CashFlowSetting {
  id      String @id @default(cuid())
  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String @unique @map("venue_id")

  // Soglia alert liquidità
  lowBalanceThreshold Decimal @default(5000) @map("low_balance_threshold") @db.Decimal(12, 2)

  // Metodo previsione entrate
  forecastMethod ForecastMethod @default(HYBRID) @map("forecast_method")

  // Giorni di storico per media mobile
  movingAverageDays Int @default(30) @map("moving_average_days")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cash_flow_settings")
}

enum ForecastMethod {
  HISTORICAL      // Solo storico anno precedente
  MOVING_AVERAGE  // Solo media mobile
  HYBRID          // Combinazione ponderata
}
